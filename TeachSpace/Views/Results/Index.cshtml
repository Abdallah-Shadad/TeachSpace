@model TeachSpace.View_Models.CourseResultsVM
@using X.PagedList.Mvc.Core
@using X.PagedList.Mvc.Core.Common
@using X.PagedList.Web.Common

@{
    ViewData["Title"] = "Course Results";
    Layout = "_AdvancedLayout";
}

<div class="row mb-4 align-items-center">
    <div class="col-md-8">
        <form asp-action="Index" method="get" class="d-flex gap-2">
            <select name="courseId" class="form-select shadow-sm" onchange="this.form.submit()">
                <option value="">-- Select Course to View Results --</option>
                @if (ViewBag.Courses != null)
                {
                    foreach (var c in ViewBag.Courses)
                    {
                        var selected = (int?)ViewBag.CourseId == c.Id;
                        if (selected)
                        {
                            <option value="@c.Id" selected>@c.Name</option>
                        }
                        else
                        {
                            <option value="@c.Id">@c.Name</option>
                        }
                    }
                }
            </select>
        </form>
    </div>

    @if (Model != null)
    {
        <div class="col-md-4 text-end">
            <a asp-action="AddTrainee" asp-route-courseId="@ViewBag.CourseId" class="btn btn-success shadow-sm">
                <i class="bi bi-person-plus-fill"></i> Add Trainee
            </a>
        </div>
    }
</div>

@if (Model != null)
{
    @if (Model.Trainees.Any())
    {
        var total = Model.Trainees.TotalItemCount;
        var passed = Model.Trainees.Count(t => t.Degree >= Model.MinDegree);
        var successRate = total > 0 ? (int)((double)passed / total * 100) : 0;

        <div class="card border-0 shadow-sm mb-4 bg-light">
            <div class="card-body py-3">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <small class="text-muted text-uppercase fw-bold">Success Rate</small>
                        <h3 class="mb-0 text-primary">@successRate%</h3>
                    </div>
                    <div class="col-md-6">
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: @successRate%"></div>
                        </div>
                    </div>
                    <div class="col-md-3 text-end">
                        <span class="badge bg-success rounded-pill me-1">@passed Passed</span>
                        <span class="badge bg-danger rounded-pill">@(total - passed) Failed</span>
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="card shadow border-0">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-journal-text"></i> @Model.CourseName</h5>
            <span class="badge bg-light text-primary">Min: @Model.MinDegree</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4" style="width: 10%;">Photo</th>
                            <th style="width: 30%;">Student Name</th>
                            <th style="width: 20%;">Degree</th>
                            <th style="width: 20%;">Status</th>
                            <th style="width: 20%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Trainees != null && Model.Trainees.Any())
                        {
                            // Pass the course max degree to the view (Assuming your VM doesn't have it yet, we can infer it or add it later.
                            // For now, let's assume 100 if not present, OR better: Ensure your VM has MaxDegree)
                            int maxDegree = 100; // Default fallback, but ideally passed from VM

                            foreach (var item in Model.Trainees)
                            {
                                <tr>
                                    <td class="ps-4">
                                        <img src="~/images/@item.Image"
                                             class="rounded-circle shadow-sm"
                                             style="width: 45px; height: 45px; object-fit: cover;"
                                             alt="Trainee" />
                                    </td>
                                    <td>
                                        <span class="fw-bold text-dark">@item.TraineeName</span>
                                    </td>
                                    <td>
                                        <span class="fs-5 fw-bold text-secondary">@item.Degree</span>
                                    </td>
                                    <td>
                                        @if (item.Degree >= Model.MinDegree)
                                        {
                                            <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill">
                                                <i class="bi bi-check-circle-fill"></i> Passed
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill">
                                                <i class="bi bi-x-circle-fill"></i> Failed
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <button type="button"
                                                class="btn btn-sm btn-outline-primary"
                                                onclick="openEditModal(@item.TraineeId, '@item.TraineeName', @item.Degree, 100)">
                                            <i class="bi bi-pencil-square"></i> Edit
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="5" class="text-center py-5 text-muted">
                                    <i class="bi bi-people fs-1 d-block mb-2"></i>
                                    No trainees found. Add one to get started!
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    @if (Model.Trainees.PageCount > 1)
    {
        <div class="d-flex justify-content-center mt-4">
            @Html.PagedListPager(Model.Trainees, page => Url.Action("Index", new { courseId = ViewBag.CourseId, page }),
            new PagedListRenderOptions
            {
                LiElementClasses = new[] { "page-item" },
                PageClasses = new[] { "page-link" },
                DisplayLinkToPreviousPage = PagedListDisplayMode.Always,
                DisplayLinkToNextPage = PagedListDisplayMode.Always
            })
</div>
    }
}
else
{
    <div class="text-center py-5">
        <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" style="width: 100px; opacity: 0.5;" class="mb-3" />
        <h4 class="text-muted">Please select a course to view results.</h4>
    </div>
}


<div class="modal fade" id="editDegreeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Update Grade</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form asp-action="EditDegree" method="post">
                <div class="modal-body text-center py-4">

                    <input type="hidden" name="CourseId" value="@ViewBag.CourseId" />
                    <input type="hidden" id="modalTraineeId" name="TraineeId" />

                    <input type="hidden" name="CourseName" value="@(Model?.CourseName ?? "")" />
                    <input type="hidden" name="TraineeName" value="Updated via Modal" />

                    <h4 id="modalTraineeNameDisplay" class="fw-bold text-dark mb-3"></h4>

                    <p class="text-muted mb-4">Enter score (Max: <span id="modalMaxDisplay">100</span>)</p>

                    <div class="form-floating w-50 mx-auto">
                        <input type="number" class="form-control fs-3 text-center fw-bold text-primary"
                               id="modalDegreeInput" name="Degree" min="0" max="100" required />
                        <label for="modalDegreeInput">Score</label>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary px-4">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function openEditModal(traineeId, traineeName, currentDegree, maxDegree) {
            // 1. Populate the modal fields
            document.getElementById('modalTraineeId').value = traineeId;
            document.getElementById('modalTraineeNameDisplay').innerText = traineeName;
            document.getElementById('modalDegreeInput').value = currentDegree;

            // 2. Set Dynamic Max Limit
            document.getElementById('modalDegreeInput').max = maxDegree;
            document.getElementById('modalMaxDisplay').innerText = maxDegree;

            // 3. Show the modal using Bootstrap 5
            var myModal = new bootstrap.Modal(document.getElementById('editDegreeModal'));
            myModal.show();
        }
    </script>
}